<!DOCTYPE html>
<html>
  <head>
	<meta charset='utf-8'>
	<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
	<link rel="stylesheet" href="style.css">
  </head>
  <body>
  Nombre de portes toqu&eacute;es : <span id="val"></span>
  Portes ouvertes : <span id="open"></span>
  <button onclick="hello()">Refresh</button>
  <div id="map"></div>
 
  <script>
	// console.log("plop");
	// document.getElementById("val").innerHTML = "plop";
	var portes;
	var map;
	var markers = [];
	
	function setMapOnAll(map) {
	  for (var i = 0; i < markers.length; i++) {
		markers[i].setMap(map);
	  }
	}
	
	function initMarkers () {
		setMapOnAll(null);
		
		var len = portes.length;
		var iconURL = 'http://maps.google.com/mapfiles/ms/icons/red-dot.png';
		var open = 0;
		for(var i = 0 ; i<len;i++ ) {
			if(portes[i].ouverte){
				iconURL = 'http://maps.google.com/mapfiles/ms/icons/green-dot.png';
				open++;
			}
			else iconURL = 'http://maps.google.com/mapfiles/ms/icons/red-dot.png';
			var marker = new google.maps.Marker({
			  map: map,
			  position: {lat : portes[i].latitude, lng : portes[i].longitude},
			  title: portes[i].adresseResume,
			  icon: iconURL,
			});
			markers[i]=marker;
		}
		$('#open').text(open);
		
		var markerCluster = new MarkerClusterer(map, markers,
				{imagePath: 'https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m'});
		  
	};
	
	function hello(){
		jQuery.ajax({	url : "http://192.168.10.102:8080/portes",
						crossDomain : true
				}).done(function( data ) {
						  console.log(data);
						  $('#val').text(data.length);
						  portes = data;
						  initMarkers();
						}).fail(function(a, b, c) {
					console.log( "error "+a+" "+b+" "+c );
				  });
		
	};
	
	function initMap() {
		// Create a map object and specify the DOM element for display.
		map = new google.maps.Map(document.getElementById('map'), {
		  center: {lat: 46.258451, lng: 2.213055},
		  scrollwheel: true,
		  zoom: 6
		});
		hello();
	};
	
	
	
    </script>
	<script src="https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/markerclusterer.js">
    </script>
     <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCOPqBdVZ59oQ885RuYlseRPmqRqE4OjzM&callback=initMap"
    async defer></script>
  </body>
</html>